---
title: 工作项目之邮件服务解决方案
date: 2019-05-02 10:13:35
tags: 
 - 学习
 - java
reward: true
toc: true
---

# 工作中邮件服务解决方案

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **最近因为工作项目的缘故，需要在项目中增加发送邮件的功能，本以为只要写个程序，使用smtp发送就可以了，然而，还是我想的太简单了。**

先来说下项目背景

## 背景

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;工作环境的电脑是windows，在办公网络环境，平时只能用来收发邮件，IM沟通以及其他事务性工作，虽然是工作电脑，由于公司对我们电脑做了管控，电脑不能上网，姑且称这个环境为A环境。平时的开发工作是在vmware horizon view的虚拟化终端里，终端里面的系统是windows7，两个环境，但是是在不同的网段，公司也做了限制，两个环境没法做通信，此环境称为B环境。开发的服务部署在另外一个开发测试环境，可以通过Vmware的终端环境（B环境）访问该环境，但是办公环境没法访问，此环境的系统是AIX系统（unix），暂称C环境。

|环境|特点|
|:---:|:---|
|A环境|办公网，可以通过Vmware方式连接B环境，但是连不上C环境，可以访问邮箱服务|
|B环境|开发测试环境，可以连接C环境，并且可以通过发送TCP协议给C，可以访问邮箱服务|
|C环境|开发测试环境，可以通过TCP方式与B环境互通，但是不能访问邮箱服务|

***以上环境的特点也是在自己使用smtp协议的程序碰壁后，静下心来好好研究做的一番整理。***

## 要实现的功能
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;项目是使用springboot开发的一个web项目，项目中有块功能是在某些场景下实现发送邮件通知。邮件要实现以下几个功能：

+ 模块化。邮件单独作为一个模块使用，暴露给调用者使用接口
+ 富文本化。发送邮件的内容不能只是纯文本的方式，内容要类似网页的方式，可以嵌入图片，字体大小可调节等功能
+ 全面化。支持发送附件

项目部署在C环境上，由于C环境不能访问邮件服务器，C环境直接发送邮件的方式这条路走不通，所以需要考虑其他实现方式。

## 设计思路

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C不能访问A，所以想通过A发邮件的想法不可能，所以，C可以通过访问B环境，把想发的邮件内容让B发邮件。

```

采用C/S模式，在C环境部署一个发邮件的客户端程序，在B环境部署一个接收发邮件指令并根据指令发邮件的服务端程序。客户端给服务器端发socket报文，服务器端接收报文信息，在开发客户端和服务端的交互上，采用了NIO方式，也是考虑了NIO很强大的性能优势，选用netty作为开发基础包。


```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 基本的socket通信已经选好了，接下来就是看如何设计报文的格式，以便双方通信，发邮件需要有几项内容：

+ 收件人
+ 抄送
+ 秘抄
+ 主题
+ 正文内容
+ 附件

其中邮件内容要可以显示图片、链接，字体样式等内容，附件就发送图片和普通的文档就可以。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 公司使用的outlook，内容可以用html的方式写，html可以展示丰富的内容，所以可以通过html的一些标签样式展示富文本的内容，但是有一个难点，图片是本地的图片，不是网络图片，这个图片怎么才能在html的内容显示出来，另外，附件怎么发送。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 经过一番的研究，附件图片可以转换成base64的字符串，在html的页面中直接引用图片的名字即可，如果附件的图片在html有引用，在outlook看起来，就没有附件，只有正文中的内容加图片，如果图片没有在html中引用到，则会在附件一栏展示

以上问题都解决了，这些字符串的发送以什么格式？这里自己是通过json的方式，将以上内容都放在json中由客户端发送给服务端，服务端解析json就可以，将对应的内容解析出来就可以。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 设计下发送的协议：

```
四位长度信息（json内容的长度）+ json内容

```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ***以上是整体的设计思路***


## 发送邮件的两种方式

1. 通过SMTP协议发送邮件，很简单。
2. jacob方式，调用windows下outlook的发送邮件的接口






























